\documentclass{article}

\bibliographystyle{plain}

\usepackage{epsfig}
\usepackage{xcolor}
\usepackage{amsmath}
\input{alias.tex}
\begin{document}

\title{Strong scaling comparison of three viscous tensor operator classes}
\author{D. T. Graves   }
\date{May 13, 2024}
\maketitle



\section{The Point of All This}

This document is meant to compare the performance of Proto-based and
Fortran-based viscous tensor operators. These operators
solve the viscous tensor equation using the
Martin-Cartwright algorithm as implemented in AMRMultigrid.
For the purposes of this document, we well identify these operators as follows.
\begin{itemize}
\item ChF Viscous is the  fortran-based Chombo operator that lives in
  {\tt Chombo/lib/src/AMRElliptic}.   The class name is {\tt
    ViscousTensorOp}.
\item Proto Slow VTO is the naive Proto implmentatation (called 
  {\tt Proto\_Viscous\_Tensor\_Op}).
\item Proto Fast VTO is a smarter Proto implmentatation (called 
  {\tt Proto\_FastVTO}).  Because Proto coarse-fine interpolation
  includes  corners, we could avoid the whole intermediate
  cell-centerd gradient calculation and do everything in one grand
  stencil that rules them all and in darkness binds them.
\end{itemize}  

\section{Important Caveats}
In trying to come up with a fair comparison between these operators, I
found myself making decisions that, at the very least, need to be
disclosed.  The explanations are not mandatory but they may be
self-exculpatory.
\begin{itemize}
\item All three are using the slowGSRB relaxation algorithm which
  properly calculates the residual everywhere on both red and black
  sweeps.    I realize this leaves performance on the table but the
  best option here (evaluation of the stencil in place on colors with
  weird skippy loops) is not available in Proto.
\item The fortran operator showed much worse multigrid convergence,
  especially in three dimensions.
\item  I do not know why this poor convergence is happening and I do not want
  to spend my life debugging the multigrid convergence of a
  decades-old operator scheduled for the scrap heap.
\item The bottom line is that I had to over smooth the fortran-based codes to get
  convergence, especially in three dimension.   This may result in
  sub-optimal performance in two dimensional examples (two and three
  dimensional runs use the same input files).
\item There are a few cases that still did not converge.   I removed
  them from the data.
\end{itemize}

\section{Summary of data marked 5-10-2024}

In two dimensions, the fortran-based operator was consistently faster
overall.   I think some work needs to be done to get the different
representations to stop at the same level of convergence.  So, in two
dimensions, this may look somewhat worse for the Proto operators than
is warranted.   At the very least, this warrants  fiddling  with the
example input files a bit more.

In three dimensions, the Proto operators are quite competive and often
even faster than the fortran implementation.
\begin{small} 
  \begin{table}[p]
    \begin{center}
      \begin{tabular}{|c|c|c|c|c|c||c|} \hline
        Op & D & Case & $N_p$ & Final $|R|$  &  Iter & Main Time \\
        \hline
        
        ChF Viscous Op & 2 & 0 & 1& 1.783595e-11 & 6 & 1.0994e+00\\
        ChF Viscous Op & 2 & 0 & 2& 1.783662e-11 & 6 & 6.1174e-01\\
        ChF Viscous Op & 2 & 0 & 4& 1.783507e-11 & 6 & 3.8586e-01\\
        Proto Slow VTO & 2 & 0 & 1& 7.096546e-13 & 13 & 7.0531e+00\\
        Proto Slow VTO & 2 & 0 & 2& 7.096546e-13 & 13 & 4.3746e+00\\
        Proto Slow VTO & 2 & 0 & 4& 7.096546e-13 & 13 & 2.7630e+00\\
        Proto Fast VTO & 2 & 0 & 1& 7.315260e-13 & 13 & 5.9470e+00\\
        Proto Fast VTO & 2 & 0 & 2& 7.315260e-13 & 13 & 3.4919e+00\\
        Proto Fast VTO & 2 & 0 & 4& 7.315260e-13 & 13 & 2.0155e+00\\
        \hline
      \end{tabular} 
    \end{center}   
    \label{__dim_=_2__case_=_0} 
    \caption{dim = 2, case = 0} 
  \end{table} 
\end{small}

\begin{small} 
  \begin{table} [p]
    \begin{center}
      \begin{tabular}{|c|c|c|c|c|c||c|} \hline
        Op & D & Case & $N_p$ & Final $|R|$  &  Iter & Main Time \\
        \hline
        ChF Viscous Op & 2 & 1 & 1& 3.920064e-11 & 9 & 1.4934e+00\\
        ChF Viscous Op & 2 & 1 & 2& 3.919354e-11 & 9 & 8.2743e-01\\
        ChF Viscous Op & 2 & 1 & 4& 3.918998e-11 & 9 & 5.1241e-01\\
        Proto Slow VTO & 2 & 1 & 1& 7.078782e-13 & 13 & 7.2282e+00\\
        Proto Slow VTO & 2 & 1 & 2& 7.078782e-13 & 13 & 4.5135e+00\\
        Proto Slow VTO & 2 & 1 & 4& 7.078782e-13 & 13 & 2.8712e+00\\
        Proto Fast VTO & 2 & 1 & 1& 7.345236e-13 & 21 & 8.2631e+00\\
        Proto Fast VTO & 2 & 1 & 2& 7.345236e-13 & 21 & 4.8452e+00\\
        Proto Fast VTO & 2 & 1 & 4& 7.345236e-13 & 21 & 2.7983e+00\\
        \hline
      \end{tabular} 
    \end{center}   
    \label{__dim_=_2__case_=_1} 
    \caption{dim = 2, case = 1} 
  \end{table} 
\end{small}

\begin{small} 
  \begin{table} 
    \begin{center}
      \begin{tabular}{|c|c|c|c|c|c||c|} \hline
        Op & D & Case & $N_p$ & Final $|R|$  &  Iter & Main Time \\
        \hline
        ChF Viscous Op & 2 & 2 & 1& 6.054535e-11 & 9 & 9.3746e-01\\
        ChF Viscous Op & 2 & 2 & 2& 6.054535e-11 & 9 & 5.5041e-01\\
        ChF Viscous Op & 2 & 2 & 4& 6.054535e-11 & 9 & 3.8586e-01\\
        Proto Fast VTO & 2 & 2 & 1& 7.009948e-13 & 21 & 8.4273e+00\\
        Proto Fast VTO & 2 & 2 & 2& 7.009948e-13 & 21 & 5.0224e+00\\
        Proto Fast VTO & 2 & 2 & 4& 7.009948e-13 & 21 & 2.9132e+00\\
        \hline
      \end{tabular} 
    \end{center}   
    \label{__dim_=_2__case_=_2} 
    \caption{dim = 2, case = 2} 
  \end{table} 
\end{small}

\begin{small} 
  \begin{table} [p]
    \begin{center}
      \begin{tabular}{|c|c|c|c|c|c||c|} \hline
        Op & D & Case & $N_p$ & Final $|R|$  &  Iter & Main Time \\
        \hline
        ChF Viscous Op & 2 & 3 & 1& 4.163159e-11 & 21 & 4.5645e-01\\
        ChF Viscous Op & 2 & 3 & 2& 4.163070e-11 & 21 & 2.9438e-01\\
        ChF Viscous Op & 2 & 3 & 4& 4.163070e-11 & 21 & 2.6304e-01\\
        Proto Slow VTO & 2 & 3 & 1& 4.942713e-13 & 13 & 9.9005e-01\\
        Proto Slow VTO & 2 & 3 & 2& 4.942713e-13 & 13 & 6.5703e-01\\
        Proto Slow VTO & 2 & 3 & 4& 4.942713e-13 & 13 & 4.7014e-01\\
        Proto Fast VTO & 2 & 3 & 1& 5.233591e-13 & 20 & 1.3334e+00\\
        Proto Fast VTO & 2 & 3 & 2& 5.233591e-13 & 20 & 8.3537e-01\\
        Proto Fast VTO & 2 & 3 & 4& 5.233591e-13 & 20 & 5.5627e-01\\

        \hline
      \end{tabular} 
    \end{center}   
    \label{__dim_=_2__case_=_3} 
    \caption{dim = 2, case = 3} 
  \end{table} 
\end{small}

\begin{small} 
  \begin{table} 
    \begin{center}
      \begin{tabular}{|c|c|c|c|c|c||c|} \hline
        Op & D & Case & $N_p$ & Final $|R|$  &  Iter & Main Time \\
        \hline
        ChF Viscous Op & 2 & 4 & 1& 9.378631e-11 & 21 & 4.1673e-01\\
        ChF Viscous Op & 2 & 4 & 2& 9.379342e-11 & 21 & 2.8667e-01\\
        ChF Viscous Op & 2 & 4 & 4& 9.379342e-11 & 21 & 2.5349e-01\\
        Proto Slow VTO & 2 & 4 & 1& 6.419310e-13 & 13 & 1.0299e+00\\
        Proto Slow VTO & 2 & 4 & 2& 6.419310e-13 & 13 & 7.0574e-01\\
        Proto Slow VTO & 2 & 4 & 4& 6.419310e-13 & 13 & 5.2431e-01\\
        Proto Fast VTO & 2 & 4 & 1& 5.297984e-13 & 20 & 1.4037e+00\\
        Proto Fast VTO & 2 & 4 & 2& 7.334133e-13 & 20 & 8.9978e-01\\
        Proto Fast VTO & 2 & 4 & 4& 7.334133e-13 & 20 & 6.4096e-01\\
        \hline
      \end{tabular} 
    \end{center}   
    \label{__dim_=_2__case_=_4} 
    \caption{dim = 2, case = 4} 
  \end{table} 
\end{small}

\begin{small} 
  \begin{table} [p]
    \begin{center}
      \begin{tabular}{|c|c|c|c|c|c||c|} \hline
        Op & D & Case & $N_p$ & Final $|R|$  &  Iter & Main Time \\
        \hline

        ChF Viscous Op & 3 & 0 & 1& 9.853118e-11 & 12 & 3.1528e+02\\
        ChF Viscous Op & 3 & 0 & 2& 9.853340e-11 & 12 & 1.7701e+02\\
        ChF Viscous Op & 3 & 0 & 4& 9.853207e-11 & 12 & 7.9786e+01\\
        ChF Viscous Op & 3 & 0 & 8& 9.853163e-11 & 12 & 4.5044e+01\\
        Proto Slow VTO & 3 & 0 & 1& 9.592327e-13 & 15 & 3.4601e+02\\
        Proto Slow VTO & 3 & 0 & 2& 9.592327e-13 & 15 & 1.9920e+02\\
        Proto Slow VTO & 3 & 0 & 4& 9.592327e-13 & 15 & 1.1311e+02\\
        Proto Slow VTO & 3 & 0 & 8& 9.592327e-13 & 15 & 6.0518e+01\\
        Proto Fast VTO & 3 & 0 & 1& 9.388046e-13 & 16 & 3.0504e+02\\
        Proto Fast VTO & 3 & 0 & 2& 9.063861e-13 & 16 & 1.6882e+02\\
        Proto Fast VTO & 3 & 0 & 4& 9.727774e-13 & 16 & 8.9513e+01\\
        Proto Fast VTO & 3 & 0 & 8& 9.388046e-13 & 16 & 4.8091e+01\\
        \hline
      \end{tabular} 
    \end{center}   
    \label{__dim_=_3__case_=_0} 
    \caption{dim = 3, case = 0} 
  \end{table} 
\end{small}

\begin{small} 
  \begin{table} [p]
    \begin{center}
      \begin{tabular}{|c|c|c|c|c|c||c|} \hline
        Op & D & Case & $N_p$ & Final $|R|$  &  Iter & Main Time \\
        \hline

        ChF Viscous Op & 3 & 1 & 1& 9.880896e-11 & 14 & 3.1190e+02\\
        ChF Viscous Op & 3 & 1 & 2& 9.880985e-11 & 14 & 2.4343e+02\\
        ChF Viscous Op & 3 & 1 & 4& 9.880896e-11 & 14 & 9.8596e+01\\
        ChF Viscous Op & 3 & 1 & 8& 9.880874e-11 & 14 & 5.4087e+01\\
        Proto Slow VTO & 3 & 1 & 1& 9.011680e-13 & 15 & 3.8495e+02\\
        Proto Slow VTO & 3 & 1 & 2& 9.011680e-13 & 15 & 2.1375e+02\\
        Proto Slow VTO & 3 & 1 & 4& 9.011680e-13 & 15 & 1.1683e+02\\
        Proto Slow VTO & 3 & 1 & 8& 9.011680e-13 & 15 & 6.5328e+01\\
        Proto Fast VTO & 3 & 1 & 1& 8.935075e-13 & 22 & 4.3738e+02\\
        Proto Fast VTO & 3 & 1 & 2& 8.907319e-13 & 22 & 2.4601e+02\\
        Proto Fast VTO & 3 & 1 & 4& 8.940626e-13 & 22 & 1.2037e+02\\
        Proto Fast VTO & 3 & 1 & 8& 9.184875e-13 & 22 & 6.7538e+01\\
        \hline

      \end{tabular} 
    \end{center}   
    \label{__dim_=_3__case_=_1} 
    \caption{dim = 3, case = 1} 
  \end{table} 
\end{small}

\begin{small} 
  \begin{table} [p]
    \begin{center}
      \begin{tabular}{|c|c|c|c|c|c||c|} \hline
        Op & D & Case & $N_p$ & Final $|R|$  &  Iter & Main Time \\
        \hline
        ChF Viscous Op & 3 & 2 & 1& 1.807132e-11 & 15 & 4.3311e+02\\
        ChF Viscous Op & 3 & 2 & 2& 1.807132e-11 & 15 & 2.8374e+02\\
        ChF Viscous Op & 3 & 2 & 4& 1.807132e-11 & 15 & 1.1176e+02\\
        ChF Viscous Op & 3 & 2 & 8& 1.807132e-11 & 15 & 6.9411e+01\\
        Proto Slow VTO & 3 & 2 & 1& 9.403589e-13 & 15 & 2.1097e+02\\
        Proto Slow VTO & 3 & 2 & 2& 9.403589e-13 & 15 & 1.2835e+02\\
        Proto Slow VTO & 3 & 2 & 4& 9.403589e-13 & 15 & 5.7464e+01\\
        Proto Slow VTO & 3 & 2 & 8& 9.403589e-13 & 15 & 3.2924e+01\\
        Proto Fast VTO & 3 & 2 & 1& 9.003909e-13 & 22 & 4.3444e+02\\
        Proto Fast VTO & 3 & 2 & 2& 8.890666e-13 & 22 & 2.4232e+02\\
        Proto Fast VTO & 3 & 2 & 4& 9.006129e-13 & 22 & 1.2046e+02\\
        Proto Fast VTO & 3 & 2 & 8& 9.131584e-13 & 22 & 6.8197e+01\\
        \hline
      \end{tabular} 
    \end{center}   
    \label{__dim_=_3__case_=_2} 
    \caption{dim = 3, case = 2} 
  \end{table} 
\end{small}

\begin{small} 
  \begin{table} [p]
    \begin{center}
      \begin{tabular}{|c|c|c|c|c|c||c|} \hline
        Op & D & Case & $N_p$ & Final $|R|$  &  Iter & Main Time \\
        \hline

        ChF Viscous Op & 3 & 3 & 1& 7.822121e-11 & 98 & 1.0312e+02\\
        ChF Viscous Op & 3 & 3 & 2& 7.821943e-11 & 98 & 6.7036e+01\\
        ChF Viscous Op & 3 & 3 & 4& 7.822099e-11 & 98 & 2.9249e+01\\
        ChF Viscous Op & 3 & 3 & 8& 7.822099e-11 & 98 & 1.7595e+01\\
        Proto Slow VTO & 3 & 3 & 1& 4.052314e-13 & 14 & 3.7960e+01\\
        Proto Slow VTO & 3 & 3 & 2& 4.052314e-13 & 14 & 2.3696e+01\\
        Proto Slow VTO & 3 & 3 & 4& 4.052314e-13 & 14 & 1.2425e+01\\
        Proto Slow VTO & 3 & 3 & 8& 4.052314e-13 & 14 & 7.4764e+00\\
        Proto Fast VTO & 3 & 3 & 1& 8.129053e-13 & 21 & 5.0020e+01\\
        Proto Fast VTO & 3 & 3 & 2& 8.129053e-13 & 21 & 3.0519e+01\\
        Proto Fast VTO & 3 & 3 & 4& 8.129053e-13 & 21 & 1.6132e+01\\
        Proto Fast VTO & 3 & 3 & 8& 8.129053e-13 & 21 & 9.5662e+00\\

        \hline
      \end{tabular} 
    \end{center}   
    \label{__dim_=_3__case_=_3} 
    \caption{dim = 3, case = 3} 
  \end{table} 
\end{small}

\begin{small} 
  \begin{table} [p]
    \begin{center}
      \begin{tabular}{|c|c|c|c|c|c||c|} \hline
        Op & D & Case & $N_p$ & Final $|R|$  &  Iter & Main Time \\
        \hline
        ChF Viscous Op & 3 & 4 & 1& 9.568346e-11 & 98 & 1.0456e+02\\
        ChF Viscous Op & 3 & 4 & 2& 9.568613e-11 & 98 & 6.7511e+01\\
        ChF Viscous Op & 3 & 4 & 4& 9.568368e-11 & 98 & 3.0511e+01\\
        ChF Viscous Op & 3 & 4 & 8& 9.568368e-11 & 98 & 1.9083e+01\\
        Proto Slow VTO & 3 & 4 & 1& 5.471179e-13 & 14 & 4.1786e+01\\
        Proto Slow VTO & 3 & 4 & 2& 5.471179e-13 & 14 & 2.4630e+01\\
        Proto Slow VTO & 3 & 4 & 4& 4.778400e-13 & 14 & 1.3277e+01\\
        Proto Slow VTO & 3 & 4 & 8& 4.778400e-13 & 14 & 8.3531e+00\\
        Proto Fast VTO & 3 & 4 & 1& 8.057999e-13 & 21 & 5.1915e+01\\
        Proto Fast VTO & 3 & 4 & 2& 8.057999e-13 & 21 & 3.1450e+01\\
        Proto Fast VTO & 3 & 4 & 4& 8.057999e-13 & 21 & 1.7320e+01\\
        Proto Fast VTO & 3 & 4 & 8& 8.057999e-13 & 21 & 1.0817e+01\\
        \hline
      \end{tabular} 
    \end{center}   
    \label{__dim_=_3__case_=_4} 
    \caption{dim = 3, case = 4} 
  \end{table} 
\end{small}






%%end of road, bub
\end{document}
